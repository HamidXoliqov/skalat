<?php

namespace App\Model;

use Illuminate\Database\Eloquent\Model;
use App\Classes\table;
use App\Model\People;
use Illuminate\Support\Facades\Auth;

class ReportPrice extends Model
{
    protected $table = 'tbl_people_reports';

    protected $fillable = [
        'people_id',
        'user_id',
        'date',
        'statr_date',
        'end_date',
        'plus_date',
        'minus_date',
        'bonus',
        'name',
        'first_name',
        'last_name',
        'position',
        'price',
        'summ',
        'reason',
        'status_timein',
        'status_timeout',
    ];
    public static function boot()
    {
        parent::boot(); // TODO: Change the autogenerated stub
        self::creating(function ($model){
            $str = $model['name'];
            $lastname = explode(",",$str)[0];
            $firstname = explode(",",$str)[1];
//            $data = People::where(['lastname'=>$lastname,'firstname'=>$firstname])->first();
            $data = People::where([['lastname','=',$lastname]])->first();
            $model->people_id =  $data['id'];
            $model->user_id =  Auth::id();
            $model->last_name = $lastname;
            $model->first_name = $firstname;
            $model->position = $data['mi'];
            $model->price = $data['price'];
            $model->status_timein = ReportPrice::statusin($model['statr_date']);
//            die($model['statr_date']);

        });
    }
    public static function add($filds)
    {
        $post = new static;
        $post->fill($filds);
        $post->save();
    }
    public function edit($filds)
    {
        $this->fill($filds);
        $this->totalhours = ReportPrice::totalhours($filds['statr_date'],$filds['end_date']);
        $this->minus_date = ReportPrice::minustime($filds['statr_date']);
        $this->plus_date = ReportPrice::plustime($filds['end_date']);
        $this->status_timeout = ReportPrice::statusout($filds['end_date']);
//        dd(explode(":",$filds['statr_date'])[1]);
        $this->save();
    }
    //--------------------
    public static function totalhours($start,$end)
    {
        if($start)
        {
            $start_min = intval(explode(":",$start)[0]);
            $start_sec = intval(explode(":",$start)[1]);
        }
        if($end)
        {
            $end_min = intval(explode(":",$end)[0]);
            $end_sec = intval(explode(":",$end)[1]);
        }
        if($end_sec - $start_sec>=0 && $end_min-$start_min>=0)
        {
            $nat_min = intval($end_min-$start_min);
            $nat_sec = intval($end_sec-$start_sec);
        }
        else
        {
            $nat_min = $end_min-$start_min-1;
            $nat_sec = 60 - $start_sec-$end_sec;
        }
        return $nat_min.' : '.$nat_sec;
    }
    //--------------
    public static function minustime($time)
    {
        if($time)
        {
            $min = intval(explode(":",$time)[0]);
            $sec = intval(explode(":",$time)[1]);
        }
        if (9<=$min)
        {
            $natmin = $min-9;
            $natsec = $sec;
        }
        else
        {
            $natmin = 8-$min;
            $natsec = 60-$sec;
        }
        return $natmin.':'.$natsec;
    }
    //------------------
    public static function plustime($time)
    {
        if($time)
        {
            $min = intval(explode(":",$time)[0]);
            $sec = intval(explode(":",$time)[1]);
        }
        if (18<=$min)
        {
            $natmin = $min-18;
            $natsec = $sec;
        }
        else
        {
            $natmin = 17-$min;
            $natsec = 60-$sec;
        }
        return $natmin.':'.$natsec;
    }
    public static function statusin($time)
    {
        if(9>intval(explode(":",$time)[0]))
        {
            $str = 'Ok';
        }
        elseif (9==intval(explode(":",$time)[0]) && 15 >= intval(explode(":",$time)[1]))
        {
            $str = 'On Time';
        }
        else
        {
            $str = 'Late In';
        }
        return $str;
    }
    public static function statusout($time)
    {
        if(18>intval(explode(":",$time)[0]))
        {
            $str = 'Early Out';
        }
        elseif (17==intval(explode(":",$time)[0]) && 45 <= intval(explode(":",$time)[1]))
        {
            $str = 'On Time';
        }
        else
        {
            $str = 'Ok';
        }
        return $str;
    }
}
